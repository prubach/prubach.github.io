<h1>My Students' Diploma Thesis</h1>

<div style="margin-bottom:1rem;">
  <label style="font-size:1.1em;font-weight:bold;">Filter by year:</label>
  <select id="yearFilter">
    <option value="all">All years</option>
  </select>

  <label style="font-size:1.1em;font-weight:bold; margin-left:1rem;">Filter by category:</label>
  <select id="categoryFilter">
    <option value="all">All categories</option>
  </select>

  <label style="font-size:1.1em;font-weight:bold; margin-left:1rem;">Search:</label>
  <input type="text" id="searchBox" placeholder="Type student name or title" style="padding:0.2rem 0.5rem;">
</div>

<div id="thesis-list"></div>

<hr>

<h2>Thesis Count Per Year</h2>
<div id="yearChart" style="height:400px;"></div>

<script>
const all_theses = {{ site.data.students | jsonify }};
let theses = all_theses
    .filter(t => t.year && t.year !== "null")       // hide null or missing year
    .sort((a, b) => Number(b.year) - Number(a.year)); // newest → oldest

const thesisList = document.getElementById("thesis-list");
const yearFilter = document.getElementById("yearFilter");
const categoryFilter = document.getElementById("categoryFilter");
const searchBox = document.getElementById("searchBox");

// Populate year filter
const years = [...new Set(theses.map(t => t.year))].sort().reverse();
years.forEach(y => {
  const opt = document.createElement("option");
  opt.value = y;
  opt.innerText = y;
  yearFilter.appendChild(opt);
});

// Populate category filter
const categories = [...new Set(theses.map(t => t.category))].sort();
categories.forEach(c => {
  const opt = document.createElement("option");
  opt.value = c;
  opt.innerText = c.charAt(0).toUpperCase() + c.slice(1);
  categoryFilter.appendChild(opt);
});

// Render thesis list
function renderList() {
  const selectedYear = yearFilter.value;
  const selectedCategory = categoryFilter.value;
  const searchText = searchBox.value.toLowerCase().trim();

  let filtered = theses;

  if (selectedYear !== "all") {
    filtered = filtered.filter(t => t.year === selectedYear);
  }
  if (selectedCategory !== "all") {
    filtered = filtered.filter(t => t.category === selectedCategory);
  }
  if (searchText) {
    filtered = filtered.filter(t =>
      t.author.toLowerCase().includes(searchText) ||
      t.title.toLowerCase().includes(searchText)
    );
  }

  // Render list
  let html = "<ul>";
  filtered.forEach(t => {
    html += `<li>${t.year} — <em>${t.author}</em> (${t.category}) — <a href="${t.url}" target="_blank"><i>${t.title}</i></a></li>`;
  });
  html += "</ul>";
  thesisList.innerHTML = html;

  renderChart(filtered);
}

// Render chart: separate bars for Master/Bachelor
function renderChart(filtered) {
  const counts = {};
  filtered.forEach(t => {
    if (!counts[t.year]) counts[t.year] = { master: 0, bachelor: 0 };
    if (t.category === "master") counts[t.year].master += 1;
    if (t.category === "bachelor") counts[t.year].bachelor += 1;
  });

  const yearsSorted = Object.keys(counts).sort();
  const masterValues = yearsSorted.map(y => counts[y].master || 0);
  const bachelorValues = yearsSorted.map(y => counts[y].bachelor || 0);

  const data = [
    { x: yearsSorted, y: masterValues, type: 'bar', name: 'Master', marker: { color: '#1f77b4' } },
    { x: yearsSorted, y: bachelorValues, type: 'bar', name: 'Bachelor', marker: { color: '#ff7f0e' } }
  ];

  const layout = {
    title: 'Number of Theses per Year',
    xaxis: { title: 'Year' },
    yaxis: { title: 'Count' },
    barmode: 'group'
  };

  Plotly.newPlot('yearChart', data, layout);
}

// Event listeners
yearFilter.addEventListener("change", renderList);
categoryFilter.addEventListener("change", renderList);
searchBox.addEventListener("input", renderList);

// Initial render
renderList();
</script>
