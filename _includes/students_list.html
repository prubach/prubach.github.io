<section id="thesis">
<h1>My Students' Diploma Thesis</h1>

<div style="margin-bottom:1rem;">
  <label style="font-size:1.1em;font-weight:bold;">Year:</label>
  <select id="yearFilter">
    <option value="all">All years</option>
  </select>

  <label style="font-size:1.1em;font-weight:bold; margin-left:1rem;">Type:</label>
  <select id="categoryFilter">
    <option value="all">All categories</option>
  </select>

  <label style="font-size:1.1em;font-weight:bold; margin-left:1rem;">Lang:</label>
  <select id="languageFilter">
    <option value="all">All</option>
  </select>

  <label style="font-size:1.1em;font-weight:bold; margin-left:1rem;">Lab:</label>
  <select id="labFilter">
    <option value="all">All labs</option>
  </select>

  <label style="font-size:1.1em;font-weight:bold; margin-left:1rem;">Search:</label>
  <input type="text" id="searchBox" placeholder="Type student name or title" style="padding:0.2rem 0.5rem;">
</div>

<div id="thesis-list"></div>

<div id="thesis-count" style="margin-top: 1rem; font-weight: bold;"></div>
<br>
<div class="label">* - thesis project realized in collaboration with the given lab</div>

<hr>

<h2>Thesis Count Per Year</h2>
<div id="yearChart" style="height:400px;"></div>

<script>
const all_theses = {{ site.data.students | jsonify }};
const lab_data = {{ site.data.students_collaboration | jsonify }};
let theses = all_theses
    .filter(t => t.year && t.year !== "null")
    .sort((a, b) => Number(b.year) - Number(a.year));

const thesisList = document.getElementById("thesis-list");
const yearFilter = document.getElementById("yearFilter");
const categoryFilter = document.getElementById("categoryFilter");
const languageFilter = document.getElementById("languageFilter");
const labFilter = document.getElementById("labFilter");
const searchBox = document.getElementById("searchBox");

// Add lab info to each thesis if author is in lab_data
theses.forEach(t => {
  const labEntry = lab_data.find(l => l.author === t.author);
  if (labEntry) {
    t.lab = labEntry.lab;
    t.lab_url = labEntry.url;
  }
});

// Populate year filter
const years = [...new Set(theses.map(t => t.year))].sort().reverse();
years.forEach(y => {
  const opt = document.createElement("option");
  opt.value = y;
  opt.innerText = y;
  yearFilter.appendChild(opt);
});

// Populate category filter
const categories = [...new Set(theses.map(t => t.category))].sort();
categories.forEach(c => {
  const opt = document.createElement("option");
  opt.value = c;
  opt.innerText = c.charAt(0).toUpperCase() + c.slice(1);
  categoryFilter.appendChild(opt);
});

// Populate language filter
const languages = [...new Set(theses.map(t => t.lang))].sort();
languages.forEach(l => {
  const opt = document.createElement("option");
  opt.value = l;
  opt.innerText = l;
  languageFilter.appendChild(opt);
});

// Populate lab filter
const labs = [...new Set(theses.map(t => t.lab).filter(Boolean))].sort();
labs.forEach(l => {
  const opt = document.createElement("option");
  opt.value = l;
  opt.innerText = l;
  labFilter.appendChild(opt);
});

function renderTheses(list) {
    thesisList.innerHTML = `
        <div class="thesis-table-header thesis-row">
            <div class="col-year">Year</div>
            <div class="col-author">Author</div>
            <div class="col-category">Type</div>
            <div class="col-title">Title</div>
            <div class="col-language">Lang</div>
            <div class="col-lab">Lab*</div>
        </div>
    `;

    list.forEach(t => {
      const item = document.createElement("div");
      item.className = "thesis-row";

      const labContent = t.lab ? `<a href="${t.lab_url}" target="_blank">${t.lab}</a>` : "";

      const langFlag = t.lang === "EN" ? "ðŸ‡¬ðŸ‡§" : "ðŸ‡µðŸ‡±";

      let labHTML = '';
      if (t.lab) {
            labHTML = `<a href="${t.lab_url}" target="_blank">
                           <img src="/assets/images/labs/${t.lab}.png" alt="${t.lab} logo" class="lab-logo">
                       </a>`;
      }

      item.innerHTML = `
            <div class="col-year">${t.year}</div>
            <div class="col-author">${t.author ?? "Unknown"}</div>
            <div class="col-category">${t.category}</div>
            <div class="col-title">
                <a href="${t.url}" target="_blank">${t.title}</a>
            </div>
            <div class="col-language">${langFlag}</div>
            <div class="col-lab">${labHTML}</div>
        `;

      /*<div className="col-language">${t.language}</div>
      <div className="col-lab">${labContent}</div>*/
      thesisList.appendChild(item);
    });
}

function renderList() {
  const selectedYear = yearFilter.value;
  const selectedCategory = categoryFilter.value;
  const selectedLanguage = languageFilter.value;
  const selectedLab = labFilter.value;
  const searchText = searchBox.value.toLowerCase().trim();

  let filtered = theses;

  if (selectedYear !== "all") filtered = filtered.filter(t => t.year === selectedYear);
  if (selectedCategory !== "all") filtered = filtered.filter(t => t.category === selectedCategory);
  if (selectedLanguage !== "all") filtered = filtered.filter(t => t.lang === selectedLanguage);
  if (selectedLab !== "all") filtered = filtered.filter(t => t.lab === selectedLab);
  if (searchText) {
    filtered = filtered.filter(t =>
      (t.author && t.author.toLowerCase().includes(searchText)) ||
      (t.title && t.title.toLowerCase().includes(searchText))
    );
  }

  renderTheses(filtered);
  renderChart(filtered);
  // Update count
  document.getElementById("thesis-count").innerText = `Total theses shown: ${filtered.length}`;
}

function renderChart(filtered) {
  const counts = {};
  filtered.forEach(t => {
    if (!counts[t.year]) counts[t.year] = { master: 0, bachelor: 0 };
    if (t.category === "master") counts[t.year].master += 1;
    if (t.category === "bachelor") counts[t.year].bachelor += 1;
  });

  const yearsSorted = Object.keys(counts).sort();
  const masterValues = yearsSorted.map(y => counts[y].master || 0);
  const bachelorValues = yearsSorted.map(y => counts[y].bachelor || 0);

  const data = [
    { x: yearsSorted, y: masterValues, type: 'bar', name: 'Master', marker: { color: '#1f77b4' } },
    { x: yearsSorted, y: bachelorValues, type: 'bar', name: 'Bachelor', marker: { color: '#ff7f0e' } }
  ];

  const layout = {
    title: 'Number of Theses per Year',
    xaxis: { title: 'Year' },
    yaxis: { title: 'Count' },
    barmode: 'group'
  };

  Plotly.newPlot('yearChart', data, layout);
}

// Event listeners
yearFilter.addEventListener("change", renderList);
categoryFilter.addEventListener("change", renderList);
languageFilter.addEventListener("change", renderList);
labFilter.addEventListener("change", renderList);
searchBox.addEventListener("input", renderList);

renderList();
</script>
<style>
    /* Grid layout for thesis table */
.thesis-table-header, .thesis-row {
  display: grid;
  grid-template-columns: 60px 180px 100px 1fr 60px 120px;
  align-items: center;
  gap: 10px;
  padding: 6px 0;
}

.thesis-table-header {
  font-weight: 600;
  border-bottom: 2px solid #ccc;
}

.thesis-row {
  border-bottom: 1px solid #eee;
}

.col-year { text-align:center; }
.col-author { overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
.col-category { text-align:center; }
.col-title { overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
.col-language { text-align:center; }
.col-lab { text-align:center; }

@media (max-width: 768px) {
  .thesis-table-header, .thesis-row {
    grid-template-columns: 50px 150px 80px 1fr 50px 100px;
  }
  .col-author, .col-title {
    font-size: 0.85rem;
  }
}
.col-title {
  overflow: visible;      /* allow content to expand */
  text-overflow: clip;    /* remove ellipsis */
  white-space: normal;    /* allow wrapping */
  word-break: break-word; /* break long words if needed */
}

</style>